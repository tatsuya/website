---
layout: post
title: マジックリンクでパスワードレスログインを実現する
date: 2020-06-24 00:20
published: true
image: /assets/images/2020-06-23-magic-links.png
author: Tatsuya Oiwa
tags: [Japanese]
---

Webサイトでログイン機能を作るとき、一般的にはユーザー名とパスワードの組み合わせか、もしくはGoogleやFacebookなど外部のプラットフォームのログイン機能と[OAuth](https://oauth.net/)の仕組みを利用してユーザー認証を行うことが多いと思います。

これらに代わる第三の方法に**パスワードレスログイン**があります。パスワードレスログインとはその名の通り、パスワードの入力を必要としないログイン方法のことです。例えば、ユーザーにパスワードを入力してもらう代わりにEmailやSMSで認証用のコードを送信するというのは、パスワードレスログインを実現する仕組みのひとつです。

パスワードレスログインのユニークな実装に**マジックリンク**というものがあります。普段SlackやMediumといったサービスを利用している方なら、一度はこのマジックリンクを目にしたことがあるかもしれません。これはEmailで上記のような認証コードの代わりに、**ログイン用のリンク**を送って、ユーザーがそのリンクをクリックすると自動でログインが完了する、というユーザーから見るとまさに**魔法**のような仕組みです。

この記事では、私が実際にマジックリンクを実装するにあたって検討した中で（おそらく）代表的であろうふたつの実装方法を紹介します。

## ステートフルな実装

ひとつ目は、ステートフルな実装です。これはサーバー側でランダムな文字列を認証用のトークンとして生成し、そのトークンを同じくサーバー側のデータストアに格納しておくことで、トークンの照合および有効性の検証を実現します。実際のフローは以下のようになります。

1. *ユーザー* : マジックリンクの送信ボタンを押す。
2. *サーバー* : ユーザーからリクエストを受け取ったら、ランダムな文字列を認証用のトークンとして生成し、データストアに有効期限つきで保存する。また、生成したトークンをマジックリンクのURLに含め、ユーザーにEmailで送信する。
3. *ユーザー* : Emailからマジックリンクをクリックする。
4. *サーバー* : マジックリンクに含まれるトークンとデータストアに保存しておいたトークンを照合し、トークンが有効であればユーザーに認証済みのステータスを返す。

## ステートレスな実装

もうひとつは、署名付きトークンを利用したステートレスな実装です。

1. *ユーザー* : マジックリンクの送信ボタンを押す。
2. *サーバー* : ユーザーからリクエストを受け取ったら、署名付きの認証用トークンを生成し、生成したトークンをマジックリンクのURLに含め、ユーザーにEmailで送信する。
3. *ユーザー* : Emailからマジックリンクをクリックする。
4. *サーバー* : マジックリンクに含まれるトークンの署名を検証し、トークンが有効であればユーザーに認証済みのステータスを返す。

ステートフルな実装との違いは、#2のトークンの生成部分と、#4のトークンの検証部分にあります。ステートフルな実装では、生成した各トークンの照合・検証に必要な情報をサーバー側で保持しておく必要がありましたが、ステートレスな実装では、トークンの文字列の中にユーザー情報を含め、そのトークンの署名を検証することによって、サーバー側でトークンの状態（State）を持たずとも同等の機能を提供することできます。ステートレスな実装を実現するためのトークン実装の一例に[JSON Web Token
(JWT) ](https://jwt.io/)があります。

## メリットとデメリット

ステートフルな実装は、ロジックが簡単、トークン文字列の自由度が高い、（必要であれば）発行済のトークンを取り消すことが可能、といったメリットがあるいっぽう、データストアを必要とするためシステムの複雑さが増す、同時に多数のリクエストを捌くケースにおいてスケーラビリティの問題が発生する、といったデメリットがあります。

ステートレスは実装は、データストアを必要としないためシステムが簡略化でき、かつトークンの生成と検証を高速に行えるメリットがあるいっぽう、トークンの実装がやや複雑になる、一度発行してしまったトークンはサーバー側で取り消すことが難しい、といったデメリットがあります。

## Quartzのマジックリンク

私が現在所属するQuartzでは、マジックリンク用のトークンにJWTとその署名アルゴリズムにECDSAを採用しました。JWTには様々な署名アルゴリズムを使用することできますが、非対称暗号で代表的なRSA（例えば[Auth0の全てのトークンはデフォルトでRSA256が採用されている](https://community.auth0.com/t/jwt-signing-algorithms-rs256-vs-hs256/7720/5)）と比較して、[ECDSAでは処理スピードを犠牲にする代わりにキーサイズ（トークン文字列の長さ）を短縮できる](https://auth0.com/blog/json-web-token-signing-algorithms-overview/#RSA-and-ECDSA-algorithms)ため、マジックリンクでより短いURLを生成したい場合、検討する価値があると思います。
